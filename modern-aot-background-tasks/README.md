# Background Tasks with .NET 9 AOT (modern UWP)

The goal of this sample is to demonstrate the usage of the Background Tasks with UWP and .NET 9 (AOT).

## Prerequisites

- Generate a proper certificate for signing the application from the `Package.appxmanifest` (Packaging tab)
- Using `Microsoft.Windows.CsWinRT` NuGet package **2.3-preview of higher**

## Projects configuration

In your Runtime Component, you need to add these options in your .csproj:

```
<PropertyGroup>
	<CsWinRTComponent>true</CsWinRTComponent>
	<CsWinRTGenerateProjection>false</CsWinRTGenerateProjection>

	<!--
		This is a non-XAML library (just a simple WinRT component), so the XAML compiler is not needed.
		Disabling the XAML compiler allows the target Windows SDK to be lower than 26100, if desired.
		This property can be removed in case this project does have to include any XAML content.      
	-->
	<EnableXamlCompilerTargetsForUwpApps>false</EnableXamlCompilerTargetsForUwpApps>
</PropertyGroup>
```

And in your application, you need to add these options in your .csproj:

```
<PropertyGroup>
	<!-- Disable due to some issues with CsWinRT, <Reference Include="[path to the component.dll]" /> is required for now -->
	<!--<CsWinRTIncludes>BkgTaskDemo.Task.RuntimeComponent;</CsWinRTIncludes>-->

	<!-- Required for background tasks support -->
	<CsWinRTMergeReferencedActivationFactories>true</CsWinRTMergeReferencedActivationFactories>
</PropertyGroup>
<ItemGroup>
	<ProjectReference Include="..\BkgTaskDemo.Task.RuntimeComponent\BkgTaskDemo.Task.RuntimeComponent.csproj" />
	<Reference Include="..\BkgTaskDemo.Task.RuntimeComponent\bin\$(Platform)\$(Configuration)\$(TargetFramework)\BkgTaskDemo.Task.RuntimeComponent.dll" />
	<!-- Register the .winmd in the APPX manifest (requires the new MSIX tooling) -->
	<!-- Need to ensure the app entrypoint is used in the manifest (instead of the component entrypoint) -->
	<WindowsMetadataReference Include="$(MSBuildThisFileDirectory)\..\BkgTaskDemo.Task.RuntimeComponent\bin\$(Platform)\$(Configuration)\$(TargetFramework)\BkgTaskDemo.Task.RuntimeComponent.winmd" Implementation="$(MSBuildProjectName).dll" />
</ItemGroup>
```

## How to run/debug the background task

You can run the application from Visual Studio but the background tasks **will not work**. You need to call manually the business logic for debugging.

To have native background tasks execution, follow these steps:


1. Create a full application package (right click on the project -> Package and Publish -> Create App Packages...)
  - Use the Sideloading option
  - Use the release configuration to ensure AOT compilation (need to ensure all the things are generated by CsWinRT for the background tasks support)

2. Install the application package (double click on the .msix file) and launch the application from the start menu
  - You need to trust the certificate you used to sign the application package (double click on the .cer file and install it in the "Trusted Root Certification Authorities" store)

3. Click on the "Register background tasks" button (one time only after the application installation)

4. You can now trigger the background tasks from Visual Studio (Debug -> Attach to Process... -> Select BkgTaskDemoApp.exe) and use the "Lifecycle Events" menu to trigger the tasks

5. If you wait 15 minutes, you can see the toast throw from the background task too (timer trigger)